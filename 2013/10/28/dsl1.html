<!DOCTYPE html>
<html>
  <head>
    <title>
      KS Sample
    </title>
    <meta chearset="UTF-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <link href="/css/kickstart.css" media="all" rel="stylesheet" type="text/css" />
    <link href="/style.css" media="all" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/kickstart.js" type="text/javascript"></script>
  </head>
  <body class="elements">
    <div class="callout clearfix">
      <h1>
        びぼーろく（仮）
      </h1>
    </div>
    <div class="grid">
      <div class="col_12">
        <ul class="tabs left">
          <li class="first current">
            <a href="#tab_blog"><i class="icon-file"></i>BLOG</a>
          </li>
          <li>
            <a href="#tab_socials"><i class="icon-twitter"></i>SOCIALS</a>
          </li>
          <li class="last">
            <a href="https://github.com/kaakaa/middleman-blog-slim-sample/tree/gh-pages"><i class="icon-github"></i>View on Gitub</a>
          </li>
        </ul><h2 id="section">はじめに</h2>

<p>先日、社内の勉強会でUWSCについての発表がありまして、そこでUWSCを使ったテストフレームワークに関する話題が出ました。</p>

<p>テストにするのなら、Groovy使ってDSLっぽく</p>

<pre><code>test {
	script {
		file hoge.uws
	}
	assert {
		assertTitle 'hoge window'
	}
}
</code></pre>

<p>みたいに書けたら良いんじゃないとか考えてたら、なんだか実装してみたくなった。</p>

<p>ちょうど翔泳社からクーポンが届いてたので、
<a href="http://www.amazon.co.jp/dp/4798125393" title="Amazon.co.jp： 実践プログラミングDSL ドメイン特化言語の設計と実装のノウハウ (Programmer’s SELECTION): Debasish Ghosh, 佐藤 竜一: 本">Amazon.co.jp： 実践プログラミングDSL ドメイン特化言語の設計と実装のノウハウ (Programmer’s SELECTION): Debasish Ghosh, 佐藤 竜一: 本</a>
を購入し、GroovyDSLの実装方法について調べたことをまとめてみる。</p>

<h3 id="static">staticメソッド</h3>

<p>まず最初に見つけた実装方法は、書籍ではなく下記リンクから。<br />
<a href="http://java.dzone.com/articles/groovy-dsl-simple-example" title="Groovy DSL - A Simple Example | Javalobby">Groovy DSL - A Simple Example | Javalobby</a></p>

<p>引数ありのメソッド呼び出しの際には"()"を省略出来るというGroovyの特性と、staticメソッドの呼び出し記述を用いて、DSLっぽい記述が出来るようになります。</p>

<pre><code>// DSL部分
Say.hello {
	to 'foo'
	from 'bar'
}

// 実装部分
class Say {
	private String to
	private String from

	static void hello(Closure closure) {
		Say say = new Say()
		closure.delegate = say
		closure()

		say()
	}

	def to(String to) {
		this.to = to
	}

	def from(String from) {
		this.from = from
	}

	def say() {
		println "Hello ${to} from ${from}"
	}
}	
</code></pre>

<p>ただ、このやり方だとどうしてもDSL部分にstaticメソッドの親クラスを記述しなくてはいけないのが気になります。
また、DSL部分と実装部分を同一ファイル内に書くか、実装部分を分離する場合はDSL部分で実装部分をimportしたり同一パッケージに含めたりする必要があります。</p>

<h3 id="groovyshell">GroovyShell</h3>

<p>ここから先は下記書籍を参考に。
<a href="http://www.amazon.co.jp/dp/4798125393" title="Amazon.co.jp： 実践プログラミングDSL ドメイン特化言語の設計と実装のノウハウ (Programmer’s SELECTION): Debasish Ghosh, 佐藤 竜一: 本">Amazon.co.jp： 実践プログラミングDSL ドメイン特化言語の設計と実装のノウハウ (Programmer’s SELECTION): Debasish Ghosh, 佐藤 竜一: 本</a></p>

<p><a href="http://groovy.codehaus.org/Embedding+Groovy" title="Groovy - Embedding Groovy">Groovy - Embedding Groovy</a></p>

<p>GroovyShellクラスのevaluateメソッドの引数に文字列を与えると、その文字列をGroovyスクリプトとして実行してくれます。</p>

<pre><code>new GroovyShell().evaluate("println 'hello world'")
</code></pre>

<p>結果</p>

<pre><code>hello world
</code></pre>

<p>このGroovyShellのevaluateメソッドとGroovyのヒアドキュメントを使うと、以下のようにDSL部分と実装部分を分離することが出来ます。</p>

<pre><code>// DSL部分が記述されたファイルを読み込む
def dsl = new File('hoge.dsl').text
// 実装部分が記述されたファイルを読み込む
def implmentation = new File('fuga.groovy').text

// ２つのファイルを結合する
def script = """
${dsl}
${implementation}
"""

new GroovyShell().evaluate(script)
</code></pre>

<p>これを使って先ほどのSay.helloの例を書き直すと</p>

<pre><code>// hoge.dsl

hello {
	to 'foo'
	from 'bat'
}

// fuga.groovy

def hello(Closure closure) {
	Say say = new Say()
	closure.delegate = say
	closure()

	say.say()	
}

class Say {
	private String to
	private String from

	def to(String to) {
		this.to = to
	}

	def from(String from) {
		this.from = from
	}

	def say(){
		println "Hello ${to} from ${from}"
	}
}	
</code></pre>

<p>helloメソッドでセイセイ言ってるので例がちょっとアレですが、こうすることでstatic呼び出しによる実装方法の場合には書かなくてはいけなかった親クラスの記述がなくなり、DSL部分を多少スッキリさせることが出来ました。<br />
また、Groovyスクリプトをevaluateしている部分をメソッド化することで、外部からの呼び出しも簡単になったと思います。</p>

<h3 id="java6-script-engine">Java6 Script Engine</h3>

<p>前項の実装ではGroovyShellを使ってGroovyスクリプトを評価していましたが、Java6のスクリプトエンジンを使って同様のことが行えます。</p>

<pre><code>ScriptEngineManager factory = new ScriptEngineManager();
ScriptEngine engine = factory.getEngineByName("groovy");
engine.eval(new InputStreamReader(
  new BufferedInputStream(G
    new SequenceInputStream(
      new FileInputStream("hoge.dsl"),
      new FileInputStream("fuga.groovy")))));
</code></pre>

<p>書籍ではJava6スクリプトエンジンの詳細については https://scripting.dev.java.net を参照するようにとの記述がありますが、該当サイトは既に存在しないようです。<br />
<a href="http://www.coderanch.com/t/591196/java/java/scripting-dev-java-net-move" title="Where did scripting.dev.java.net move to? (Java in General forum at JavaRanch)">Where did scripting.dev.java.net move to? (Java in General forum at JavaRanch)</a>  </p>

<p><a href="https://github.com/nickman/javax-scripting" title="nickman/javax-scripting">nickman/javax-scripting</a><br />
<a href="http://docs.oracle.com/javase/jp/6/technotes/guides/scripting/programmer_guide/" title="Java スクリプトプログラマーズガイド">Java スクリプトプログラマーズガイド</a>  </p>

<h3 id="closure">Closure</h3>

<p>これまでのGroovyShellやスクリプトエンジンでの実行を行った場合、その実行は呼び出し側とは別のクラスローダーでロードされるという欠点があります。  </p>

<p>既存Javaアプリケーションの拡張としてGroovyDSLを用いる場合、同一クラスローダー上でDSL実装を動作させる手法は下記のようになります。  </p>

<pre><code>// RunScript.java

import groovy.lang.Closure;
import groovy.lang.GroovyClassLoader;
import groovy.lang.Script;

import java.io.File;
import java.io.IOException;

import org.codehaus.groovy.control.CompilationFailedException;

public class RunScript {
	public void run() throws CompilationFailedException,
			InstantiationException, IllegalAccessException, IOException {
		final Closure dsl = (Closure) ((Script) new GroovyClassLoader()
				.parseClass(new File("say.dsl")).newInstance()).run();
		
		final Fuga fuga = new Fuga();
		
		dsl.setDelegate(fuga);
		dsl.call();
	}
}


// Fuga.groovy

class Say {
	private String to
	private String from
	
	def to(String to){
		this.to = to
	}
	
	def from(String from){
		this.from = from
	}
	
	def say(){
		println "Hello ${to} from ${from}"
	}
}

def hello(Closure closure) {
	Say say = new Say()
	closure.delegate = say
	closure()
	
	say.say()
}


// hoge.dsl

{ -&gt;
hello {
	to 'foo'
	from 'bar'
}
}
</code></pre>

<p>Fuga.groovyをコンパイルしておき、DSL部分をGroovyClassLoaderでロードし、クロージャーとして扱います。<br />
DSLをクロージャーとして扱うためにhoge.dslの最初と最後にクロージャーを表す中括弧が出現してしまうのが、少し気持ち悪いですね。<br />
また、Javaアプリケーションに組み込むにはクロージャーを使えるようにするためにGroovyのjarを読みこませるなどしないといけないようです。<br />
（この辺りはJava8のLambdaでなんとか出来たりするのでしょうか…）  </p>

<p>ただ、これにより既存コードと同一のクラスローダ上でDSLを実行できるようになります。  </p>

      </div>
      <hr />
      <div class="col_12">
        <div class="col_4">
          <h4>
            Profile
          </h4>
          <img class="align-center" src="http://placehold.it/169x130/4D99E0/ffffff.png&text=full+width" />
          <p>
            live in Yokohama. Software Engineer. Java / Groovy / Ruby / Sinatra / Trac / Jenkins
          </p>
        </div>
        <div class="col_5">
          <h5>
            Recent Articles
          </h5>
          <ul class="alt">
            <li>
              <a href="/2013/10/28/dsl1.html">GroovyDSLの実装方法</a>
            </li>
            <li>
              <a href="/2013/10/10/webfrontier_seminar.html">2013年秋 Web開発最前線テックトーク</a>
            </li>
            <li>
              <a href="/2013/10/07/example-article.html">Example Article</a>
            </li>
            <li>
              <a href="/2013/10/06/example-article.html">Example Article</a>
            </li>
            <li>
              <a href="/2013/10/05/example-article.html">Example Article</a>
            </li>
            <li>
              <a href="/2013/09/24/1380029870.html">Githubリポジトリのデフォルトブランチを変更する</a>
            </li>
            <li>
              <a href="/2013/09/15/20130915.html">Sinatraアプリを定期的に実行するために泥臭く行ってみた</a>
            </li>
            <li>
              <a href="/2013/09/10/20130910.html">Node.js(Express)でフィードアグリゲータを作り始め</a>
            </li>
            <li>
              <a href="/2013/09/03/20130903.html">SinatraでFeedAggregator</a>
            </li>
            <li>
              <a href="/2013/08/19/1376919346.html">社内勉強会 - 書籍管理Webシステム</a>
            </li>
            <li>
              <a href="/2013/07/18/1374154333.html">Gitbucket1.2で500エラー</a>
            </li>
          </ul>
        </div>
        <div class="col_3">
          <h5>
            By Year
          </h5>
          <ul class="alt">
            <li>
              <a href="/2013.html">2013</a>(26)
            </li>
            <li>
              <a href="/2012.html">2012</a>(81)
            </li>
            <li>
              <a href="/2011.html">2011</a>(31)
            </li>
          </ul>
        </div>
      </div>
    </div>
    <hr />
    <div class="footer">
      <p>
        &copy; Copyright 2013 kaakaa
      </p>
    </div>
  </body>
</html>